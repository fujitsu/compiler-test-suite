MODULE mod1
IMPLICIT NONE

TYPE t1
  REAL(KIND = 8) :: r1
END TYPE

TYPE,EXTENDS(t1) :: t2
  REAL(KIND = 8) :: r2
END TYPE

END MODULE

PROGRAM main
USE mod1     
IMPLICIT NONE

CLASS(*),ALLOCATABLE :: allc
TYPE(t2),ALLOCATABLE :: res

ALLOCATE(res)
ALLOCATE(t2 :: allc)
res = fun(allc)

IF(res%r2 .EQ. 3.0) THEN
  PRINT*,'pass'
ELSE
  PRINT*,101
END IF

CONTAINS

FUNCTION fun(dd1)
IMPLICIT NONE
CLASS(t2),ALLOCATABLE :: fun
CLASS(*),ALLOCATABLE :: dd1
ALLOCATE(fun)
SELECT TYPE(dd1)
TYPE IS(t2)
  dd1%r2 = 1.0
  ASSOCIATE(aa => dd1%r2 * 3.0)
    fun%r2 = aa
  END ASSOCIATE
END SELECT
END FUNCTION

END PROGRAM
