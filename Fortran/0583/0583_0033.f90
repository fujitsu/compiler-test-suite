MODULE MOD1
TYPE TY0
INTEGER,ALLOCATABLE :: JJ
TYPE(TY1),ALLOCATABLE :: NODE2
  
CONTAINS
PROCEDURE :: WFORM1
PROCEDURE :: RFORM1
GENERIC :: WRITE(FORMATTED) => WFORM1
GENERIC :: READ(FORMATTED)  => RFORM1
END TYPE

TYPE TY1
INTEGER,ALLOCATABLE :: II
CHARACTER(LEN=:),ALLOCATABLE :: MSG
TYPE(TY0), ALLOCATABLE :: NODE1
  
CONTAINS
PROCEDURE :: WFORM2
PROCEDURE :: RFORM2
GENERIC :: WRITE(FORMATTED) => WFORM2
GENERIC :: READ(FORMATTED)  => RFORM2
END TYPE

TYPE(TY1),ALLOCATABLE :: OBJ
TYPE(TY1),ALLOCATABLE :: OBJ2

CONTAINS
SUBROUTINE WFORM1 (DTV, UNIT, IOTYPE, VLIST, IOSTAT, IOMSG)
CLASS(TY0), INTENT(IN)     :: DTV
INTEGER, INTENT(IN) :: UNIT
CHARACTER(*), INTENT(IN)    :: IOTYPE
INTEGER, INTENT(IN)         :: VLIST(:)
INTEGER, INTENT(OUT)        :: IOSTAT
CHARACTER(*), INTENT(INOUT) :: IOMSG

IF (ALLOCATED(DTV%JJ))THEN
WRITE(UNIT, *, IOSTAT = IOSTAT, IOMSG = IOMSG) DTV%JJ
ENDIF

IF(ALLOCATED(DTV%NODE2))then
 WRITE(UNIT,*,IOSTAT=IOSTAT,IOMSG=IOMSG) DTV%NODE2
ENDIF
END SUBROUTINE

SUBROUTINE RFORM1 (DTV, UNIT, IOTYPE, VLIST, IOSTAT, IOMSG)
CLASS(TY0), INTENT(INOUT)  :: DTV
INTEGER, INTENT(IN) :: UNIT
CHARACTER(*), INTENT(IN)    :: IOTYPE
INTEGER, INTENT(IN)         :: VLIST(:)
INTEGER, INTENT(OUT)        :: IOSTAT
CHARACTER(*), INTENT(INOUT) :: IOMSG

IF (ALLOCATED(DTV%JJ))THEN
READ(UNIT,*,IOSTAT=IOSTAT,IOMSG=IOMSG) DTV%JJ
ENDIF

IF(ALLOCATED(DTV%NODE2))THEN
 READ(UNIT,*,IOSTAT=IOSTAT,IOMSG=IOMSG) DTV%NODE2
ENDIF
END SUBROUTINE

SUBROUTINE WFORM2 (DTV, UNIT, IOTYPE, VLIST, IOSTAT, IOMSG)
CLASS(TY1), INTENT(IN)     :: DTV
INTEGER, INTENT(IN) :: UNIT
CHARACTER(*), INTENT(IN)    :: IOTYPE
INTEGER, INTENT(IN)         :: VLIST(:)
INTEGER, INTENT(OUT)        :: IOSTAT
CHARACTER(*), INTENT(INOUT) :: IOMSG

IF (ALLOCATED(DTV%II))THEN
WRITE(UNIT, *, IOSTAT = IOSTAT, IOMSG = IOMSG) DTV%II
ENDIF

IF (ALLOCATED(DTV%MSG))THEN
WRITE(UNIT, *, IOSTAT = IOSTAT, IOMSG = IOMSG) DTV%MSG
ENDIF

IF(ALLOCATED(DTV%NODE1))then
 WRITE(UNIT,*,IOSTAT=IOSTAT,IOMSG=IOMSG) DTV%NODE1
ENDIF
END SUBROUTINE

SUBROUTINE RFORM2 (DTV, UNIT, IOTYPE, VLIST, IOSTAT, IOMSG)
CLASS(TY1), INTENT(INOUT)  :: DTV
INTEGER, INTENT(IN) :: UNIT
CHARACTER(*), INTENT(IN)    :: IOTYPE
INTEGER, INTENT(IN)         :: VLIST(:)
INTEGER, INTENT(OUT)        :: IOSTAT
CHARACTER(*), INTENT(INOUT) :: IOMSG

IF (ALLOCATED(DTV%II))THEN
READ(UNIT,*,IOSTAT=IOSTAT,IOMSG=IOMSG) DTV%II
ENDIF

IF (ALLOCATED(DTV%MSG))THEN
READ(UNIT,*,IOSTAT=IOSTAT,IOMSG=IOMSG) DTV%MSG
ENDIF

IF(ALLOCATED(DTV%NODE1))THEN
 READ(UNIT,*,IOSTAT=IOSTAT,IOMSG=IOMSG) DTV%NODE1
ENDIF
END SUBROUTINE
END MODULE

PROGRAM MAIN
USE MOD1

ALLOCATE(OBJ)
ALLOCATE(OBJ%II)
ALLOCATE(CHARACTER(LEN=5)::OBJ%MSG)
ALLOCATE(OBJ%NODE1)
ALLOCATE(OBJ%NODE1%JJ)
ALLOCATE(OBJ%NODE1%NODE2)
ALLOCATE(OBJ%NODE1%NODE2%II)
ALLOCATE(OBJ%NODE1%NODE2%NODE1)
ALLOCATE(OBJ%NODE1%NODE2%NODE1%JJ)
ALLOCATE(OBJ%NODE1%NODE2%NODE1%NODE2)
ALLOCATE(OBJ%NODE1%NODE2%NODE1%NODE2%II)
ALLOCATE(CHARACTER(LEN=5)::OBJ%NODE1%NODE2%NODE1%NODE2%MSG)
ALLOCATE(OBJ%NODE1%NODE2%NODE1%NODE2%NODE1)
ALLOCATE(OBJ%NODE1%NODE2%NODE1%NODE2%NODE1%JJ)

OBJ%II = 21
OBJ%MSG = "HELLO"
OBJ%NODE1%JJ = 22
OBJ%NODE1%NODE2%II = 23
OBJ%NODE1%NODE2%NODE1%JJ = 24
OBJ%NODE1%NODE2%NODE1%NODE2%II = 25
OBJ%NODE1%NODE2%NODE1%NODE2%MSG = "NIGHT"
OBJ%NODE1%NODE2%NODE1%NODE2%NODE1%JJ = 26

ALLOCATE(OBJ2)
ALLOCATE(OBJ2%II)
ALLOCATE(CHARACTER(LEN=6)::OBJ2%MSG)
ALLOCATE(OBJ2%NODE1)
ALLOCATE(OBJ2%NODE1%JJ)
ALLOCATE(OBJ2%NODE1%NODE2)
ALLOCATE(OBJ2%NODE1%NODE2%II)
ALLOCATE(OBJ2%NODE1%NODE2%NODE1)
ALLOCATE(OBJ2%NODE1%NODE2%NODE1%JJ)
ALLOCATE(OBJ2%NODE1%NODE2%NODE1%NODE2)
ALLOCATE(OBJ2%NODE1%NODE2%NODE1%NODE2%II)
ALLOCATE(CHARACTER(LEN=6)::OBJ2%NODE1%NODE2%NODE1%NODE2%MSG)
ALLOCATE(OBJ2%NODE1%NODE2%NODE1%NODE2%NODE1)
ALLOCATE(OBJ2%NODE1%NODE2%NODE1%NODE2%NODE1%JJ)

OBJ2%II = 21
OBJ2%MSG = "NIGHTT"
OBJ2%NODE1%JJ = 22
OBJ2%NODE1%NODE2%II = 23
OBJ2%NODE1%NODE2%NODE1%JJ = 24
OBJ2%NODE1%NODE2%NODE1%NODE2%II = 25
OBJ2%NODE1%NODE2%NODE1%NODE2%MSG = "HELLOO"
OBJ2%NODE1%NODE2%NODE1%NODE2%NODE1%JJ = 26

OPEN(UNIT=71, FILE='fort.90', FORM='FORMATTED')
WRITE(UNIT=71,*) OBJ2,OBJ
CLOSE(UNIT=71)

OPEN(UNIT=77, FILE='fort.90', FORM='FORMATTED')
READ(UNIT=77,*) OBJ,OBJ2
CLOSE(UNIT=77, STATUS='DELETE')

if (OBJ%II /= 21) print*, 101
if (OBJ%MSG /= "NIGHT") print*, 102
if (OBJ%NODE1%JJ /= 22) print*, 103
if (OBJ%NODE1%NODE2%II /= 23) print*, 104
if (OBJ%NODE1%NODE2%NODE1%JJ /= 24) print*, 105
if (OBJ%NODE1%NODE2%NODE1%NODE2%II /= 25) print*, 106
if (OBJ%NODE1%NODE2%NODE1%NODE2%MSG /= "HELLO") print*, 107
if (OBJ%NODE1%NODE2%NODE1%NODE2%NODE1%JJ /= 26) print*, 108
if (OBJ2%II /= 21) print*, 201
if (OBJ2%MSG /= "HELLO") print*, 202, OBJ2%MSG
if (OBJ2%NODE1%JJ /= 22) print*, 203
if (OBJ2%NODE1%NODE2%II /= 23) print*, 204
if (OBJ2%NODE1%NODE2%NODE1%JJ /= 24) print*, 205
if (OBJ2%NODE1%NODE2%NODE1%NODE2%II /= 25) print*, 206
if (OBJ2%NODE1%NODE2%NODE1%NODE2%MSG /= "NIGHT") print*, 207
if (OBJ2%NODE1%NODE2%NODE1%NODE2%NODE1%JJ /= 26) print*, 208
print*,"PASS"
END
